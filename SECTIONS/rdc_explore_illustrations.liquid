{{ 'rdc_explore_illustrations.css' | asset_url | stylesheet_tag }}

<div class="rdc-fragments-section" data-section-id="{{ section.id }}">
  <div class="fragments-hero">
    {%- comment -%} Titre et sous-titre alignés à gauche {%- endcomment -%}
    <div class="fragments-header-title">
      <h1 class="fragments-title">
        {{ section.settings.title | default: "EXPLORER" }}
        <span class="fragments-subtitle">{{ section.settings.subtitle | default: "NOS CRÉATIONS" }}</span>
      </h1>
      
      {%- comment -%} Compter les artistes uniques {%- endcomment -%}
      {%- assign all_artists = '' -%}
      {% for block in section.blocks %}
        {% if block.settings.artist != blank %}
          {%- assign clean_artist = block.settings.artist | strip -%}
          {%- unless all_artists contains clean_artist -%}
            {%- if all_artists == '' -%}
              {%- assign all_artists = clean_artist -%}
            {%- else -%}
              {%- assign all_artists = all_artists | append: '|' | append: clean_artist -%}
            {%- endif -%}
          {%- endunless -%}
        {% endif %}
      {% endfor %}
      {%- assign artists_array = all_artists | split: '|' -%}
      {%- assign artists_count = artists_array.size -%}
      
      <p class="fragments-meta">
        {{ section.blocks.size }} illustrations disponibles, {{ artists_count }} artiste{% if artists_count > 1 %}s{% endif %}
      </p>
    </div>

    {%- comment -%} Barre de recherche {%- endcomment -%}
    <div class="fragments-search">
      <input 
        type="text" 
        class="fragments-search-input" 
        placeholder="{{ section.settings.search_placeholder | default: 'Rechercher un fragment...' }}"
        id="fragments-search-{{ section.id }}"
      >
    </div>

    {%- comment -%} Filtres de catégories personnalisés {%- endcomment -%}
    <div class="fragments-filters">
      <button class="fragments-filter active" data-filter="all">
        ✨ Tous les fragments
      </button>
      
      {%- comment -%} Collecter tous les tags uniques depuis les blocs {%- endcomment -%}
      {%- assign all_tags = '' -%}
      {% for block in section.blocks %}
        {% if block.settings.tags != blank %}
          {%- assign block_tags = block.settings.tags | split: ',' -%}
          {% for tag in block_tags %}
            {%- assign clean_tag = tag | strip -%}
            {%- unless all_tags contains clean_tag -%}
              {%- if all_tags == '' -%}
                {%- assign all_tags = clean_tag -%}
              {%- else -%}
                {%- assign all_tags = all_tags | append: '|' | append: clean_tag -%}
              {%- endif -%}
            {%- endunless -%}
          {% endfor %}
        {% endif %}
      {% endfor %}
      
      {%- comment -%} Afficher un bouton pour chaque tag unique {%- endcomment -%}
      {%- assign tags_array = all_tags | split: '|' -%}
      {% for tag in tags_array %}
        <button class="fragments-filter" data-filter="{{ tag | handleize }}">
          {{ tag }}
        </button>
      {% endfor %}
    </div>
  </div>

  {%- comment -%} Carrousel horizontal scrollable {%- endcomment -%}
  <div class="fragments-carousel-container">
    <div class="fragments-carousel" id="fragments-carousel-{{ section.id }}">
      {%- comment -%} Cartes depuis les blocs personnalisés {%- endcomment -%}
      
      {% if section.blocks.size > 0 %}
        {% for block in section.blocks %}
          <div class="fragment-card" 
               data-index="{{ forloop.index0 }}"
               data-block-id="{{ block.id }}"
               data-excerpt="{{ block.settings.description | strip_html | truncate: 200 | escape }}"
               data-tags="{% if block.settings.tags != blank %}{{ block.settings.tags }}{% endif %}">
            
            <div class="fragment-card-wrapper">
              {%- comment -%} Colonne gauche : Image {%- endcomment -%}
              <div class="fragment-card-image-col">
                {% if block.settings.image_dark != blank %}
                  <img src="{{ block.settings.image_dark | image_url: width: 600 }}" alt="{{ block.settings.title }}" class="fragment-image">
                {% elsif block.settings.image_light != blank %}
                  <img src="{{ block.settings.image_light | image_url: width: 600 }}" alt="{{ block.settings.title }}" class="fragment-image">
                {% else %}
                  <div class="fragment-image-placeholder"></div>
                {% endif %}
              </div>
              
              {%- comment -%} Colonne droite : Contenu {%- endcomment -%}
              <div class="fragment-card-content-col">
                <h3 class="fragment-card-title">{{ block.settings.title | default: "Titre de l'illustration" }}</h3>
                
                {% if block.settings.artist != blank %}
                  <p class="fragment-card-artist">Artiste : {{ block.settings.artist }}</p>
                {% endif %}
                
                <div class="fragment-card-description">
                  {{ block.settings.description }}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
        
      {% else %}
        {%- comment -%} Fallback: Carte de test si aucun bloc n'est ajouté {%- endcomment -%}
        <div class="fragment-card" data-index="0">
          <div class="fragment-card-inner">
            <div class="fragment-card-image" style="background: linear-gradient(135deg, #5D6D7E 0%, #34495E 100%);"></div>
            <div class="fragment-card-content">
              <p>Ajoutez des blocs d'illustrations dans les paramètres de la section</p>
            </div>
          </div>
          <h3 class="fragment-card-title">Aucune illustration</h3>
        </div>
      {% endif %}
    </div>

    {%- comment -%} Contrôles de navigation {%- endcomment -%}
    <button class="carousel-nav carousel-nav-prev" aria-label="Précédent">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>
    <button class="carousel-nav carousel-nav-next" aria-label="Suivant">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
  </div>

  {%- comment -%} Indicateurs générés dynamiquement par JavaScript {%- endcomment -%}
  <div class="fragments-indicators" id="fragments-indicators-{{ section.id }}">
    {%- comment -%} Les indicateurs seront générés par le JS en fonction du nombre de cartes affichées {%- endcomment -%}
  </div>
</div>

<script src="{{ 'rdc_explore_illustrations.js' | asset_url }}" defer="defer"></script>

{% schema %}
{
  "name": "RDC Fragments d'Histoire",
  "tag": "section",
  "class": "section-rdc-fragments",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Titre principal",
      "default": "EXPLORER"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Sous-titre",
      "default": "NOS CRÉATIONS"
    },
    {
      "type": "number",
      "id": "artists_count",
      "label": "Nombre d'artistes",
      "default": 4
    },
    {
      "type": "text",
      "id": "search_placeholder",
      "label": "Placeholder de recherche (masquée dans le code)",
      "default": "Rechercher un fragment..."
    }
  ],
  "blocks": [
    {
      "type": "illustration",
      "name": "Illustration",
      "settings": [
        {
          "type": "image_picker",
          "id": "image_light",
          "label": "Image - Fond Clair",
          "info": "Version de l'illustration pour le thème clair"
        },
        {
          "type": "image_picker",
          "id": "image_dark",
          "label": "Image - Fond Sombre",
          "info": "Version de l'illustration pour le thème sombre"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Titre",
          "default": "Titre de l'illustration"
        },
        {
          "type": "text",
          "id": "artist",
          "label": "Artiste",
          "default": "Nom de l'artiste"
        },
        {
          "type": "text",
          "id": "tags",
          "label": "Tags (séparés par des virgules)",
          "default": "Nordique, Guerrier",
          "info": "Exemple: Nordique, Guerrier, Mythologie"
        },
        {
          "type": "richtext",
          "id": "description",
          "label": "Description",
          "default": "<p>Ajoutez une description de l'illustration ici.</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "RDC Reliques",
      "blocks": [
        {
          "type": "illustration",
          "settings": {
            "title": "VALKYRIE"
          }
        },
        {
          "type": "illustration",
          "settings": {
            "title": "ODIN"
          }
        },
        {
          "type": "illustration",
          "settings": {
            "title": "THOR"
          }
        }
      ]
    }
  ],
  "max_blocks": 50
}
{% endschema %}
