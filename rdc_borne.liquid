{% schema %}
{
  "name": "Borne RDC",
  "settings": [
    {
      "type": "text",
      "id": "categories",
      "label": "Catégories (séparées par des virgules)",
      "default": "T-shirts, Débardeurs, Sweatshirts",
      "info": "Les images associées doivent être nommées 'nom_categorie.webp'"
    },
    {
      "type": "collection_list",
      "id": "collections",
      "label": "Collections à afficher",
      "limit": 20
    },
    {
      "type": "textarea",
      "id": "collection_descriptions",
      "label": "Descriptions personnalisées des collections",
      "info": "Format : Collection:Description|etc... "
    },
    {
      "type": "textarea",
      "id": "collection_links",
      "label": "Mapping",
      "info": "Liens des catégories avec les collections. Format : Catégorie:Collection,Collection|etc...",
    },
  ],
  "presets": [
    {
      "name": "Borne RDC",
      "category": "Collection"
    }
  ]
}
{% endschema %}

<div class="rdc-borne">
  <button class="rdc-borne__back-button" data-action="back">
    <span class="rdc-borne__back-icon">&larr;</span> Retour
  </button>

  <!-- Écran 1: Catégories -->
  <div class="rdc-borne__screen" data-screen="1" data-active="true">
    <div class="rdc-borne__content">
      <h1 class="rdc-borne__title">Choisissez votre catégorie</h1>
      <div class="rdc-borne__categories">
        {% assign categories = section.settings.categories | split: ',' %}
        {% for category in categories %}
          {% assign category_clean = category | strip %}
          <div class="rdc-borne__category" data-category="{{ category_clean }}">
            <div class="rdc-borne__category-inner">
              <img src="{{ category_clean | handleize | append: '.webp' | file_url }}" alt="{{ category_clean }}" class="rdc-borne__category-image">
              <h2 class="rdc-borne__category-title">{{ category_clean }}</h2>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Écran 2 -->
  <div class="rdc-borne__screen" data-screen="2" data-active="false">
    <input type="hidden" id="selected-category" value="">
    <div class="rdc-borne__content">
      {% assign category = '' %}

      {% assign selected_collections = section.settings.collection_links | split: '|' %}

      <h1>Collections</h1>
      <p class="rdc-borne__selected-category">{{ category_clean }}</p>

      <div class="rdc-borne__collections">
        {% for collection in section.settings.collections %}
          <div class="rdc-borne__collection" data-handle="{{ collection.handle }}">
            <img src="{{ collection.featured_image | img_url: '600x600', crop: 'center' }}" alt="{{ collection.title }}" class="rdc-borne__collection-image">
            <h3>{{ collection.title }}</h3>
          </div>
        {% endfor %}
      </div>
    </div>
    <button class="rdc-borne__next-button" data-action="next" data-target="3">Suivant</button>
  </div>

  <!-- Écran 3: Produits de la collection -->
  <div class="rdc-borne__screen" data-screen="3" data-active="false">
    <div class="rdc-borne__content">
      <h1 class="rdc-borne__collection-title"></h1>
      {% for collection in section.settings.collections %}
        <div class="rdc-borne__products" data-collection="{{ collection.handle }}" style="display: none;">
          {% paginate collection.products by 24 %}
            {% for product in collection.products %}
              <div class="rdc-borne__product" data-handle="{{ product.handle }}" data-product-json="{{ product | json | escape }}">
                <img src="{{ product.featured_image | img_url: '600x600', crop: 'center' }}" alt="{{ product.title }}" class="rdc-borne__product-image">
                <h3>{{ product.title }}</h3>
                <p class="rdc-borne__product-price">{{ product.price | money }}</p>
              </div>
            {% endfor %}
          {% endpaginate %}
        </div>
      {% endfor %}
    </div>
    <button class="rdc-borne__next-button" data-action="next" data-target="4">Suivant</button>
  </div>

  <!-- Écran 4: Détail produit -->
  <div class="rdc-borne__screen" data-screen="4" data-active="false">
    <div class="rdc-borne__content">
      {% for collection in section.settings.collections %}
        {% for product in collection.products %}
          <div class="rdc-borne__product-detail" data-product-handle="{{ product.handle }}" style="display: none;">
            <div class="rdc-borne__product-images">
              <div class="rdc-borne__selected-color">Couleur: <span class="rdc-borne__color-name">{{ product.variants.first.options[0] }}</span></div>
              <img class="rdc-borne__product-main-image" src="{{ product.featured_image | img_url: '800x800', crop: 'center' }}" alt="{{ product.title }}">
            </div>
            <div class="rdc-borne__product-info">
              <h1 class="rdc-borne__product-title">{{ product.title }}</h1>
              <div class="rdc-borne__product-price">{{ product.price | money }}</div>
              <div class="rdc-borne__product-description">{{ product.description }}</div>
              
              {% if product.variants.size > 1 %}
                {% for option in product.options_with_values %}
                  {% assign option_index = forloop.index0 %}
                  {% if option.name == 'Couleur' %}
                  <div class="rdc-borne__option-wrapper">
                    <div class="rdc-borne__option-values rdc-borne__option-values--color">
                      {% for value in option.values %}
                        {% for variant in product.variants %}
                          {% if variant.options[option_index] == value %}
                            {% assign matching_variant = variant %}
                            {% break %}
                          {% endif %}
                        {% endfor %}
                        {% assign color_option = value | handleize %}
                        {% assign variant_image = nil %}
                        {% assign swatch_image = nil %}
                        
                        {% comment %}Chercher dans le metafield Couleur{% endcomment %}
                        {% assign color_data = product.metafields.custom.couleur.value %}
                        {% if color_data != blank %}
                          {% for color in color_data %}
                            {% if color.label == value %}
                              {% assign variant_image = color.image %}
                              {% assign swatch_image = color.image %}
                              {% break %}
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                        
                        {% comment %}Si pas d'image dans les metafields, utiliser l'image de la variante{% endcomment %}
                        {% unless swatch_image %}
                          {% for variant in product.variants %}
                            {% if variant.options[option_index] == value %}
                              {% if variant.image %}
                                {% assign variant_image = variant.image %}
                                {% assign swatch_image = variant.image %}
                                {% break %}
                              {% endif %}
                            {% endif %}
                          {% endfor %}
                        {% endunless %}
                        
                        {% comment %}Si toujours pas d'image, utiliser l'image principale{% endcomment %}
                        {% unless variant_image %}
                          {% assign variant_image = product.featured_image %}
                          {% assign swatch_image = product.featured_image %}
                        {% endunless %}
                        
                        <button 
                          class="rdc-borne__swatch{% unless matching_variant.available %} sold-out{% endunless %}" 
                          {% unless matching_variant.available %}disabled{% endunless %}
                          data-color="{{ color_option }}"
                          data-variant-id="{{ matching_variant.id }}"
                          data-image-url="{{ variant_image | image_url: width: 600 }}">
                          <img 
                            src="{{ swatch_image | image_url: width: 50 }}"
                            alt="{{ value }}" 
                            class="rdc-borne__swatch-image">
                        </button>
                      {% endfor %}
                    </div>
                  </div>
                {% else %}
                  <div class="rdc-borne__option-select">
                    <label for="option-{{ option.name | handleize }}">{{ option.name }}</label>
                    <select id="option-{{ option.name | handleize }}" class="rdc-borne__variant-select" data-option-index="{{ option_index }}">
                      {% for value in option.values %}
                        <option value="{{ value }}">{{ value }}</option>
                      {% endfor %}
                    </select>
                  </div>
                {% endif %}
                {% assign option_index = option_index | plus: 1 %}
              {% endfor %}
            {% endif %}
              
              <button class="rdc-borne__add-to-cart" data-variant-id="{{ product.first_available_variant.id }}">Ajouter au panier</button>
            </div>
          </div>
        {% endfor %}
      {% endfor %}
    </div>
  </div>
</div>

<script type="application/json" id="rdc-borne-data">
  {{ section.settings.collection_links }}
</script>

<script type="application/json" id="rdc-borne-collection-images">
  {% assign collection_images = '' %}
  {% for collection in section.settings.collections %}
    {% assign collection_images = collection_images | append: collection.title | append: ':' | append: collection.featured_image | img_url: '600x600', crop: 'center' %}
    {% unless forloop.last %}
      {% assign collection_images = collection_images | append: '|' %}
    {% endunless %}
  {% endfor %}
  {{ collection_images }}
</script>

{{ 'rdc_borne.css' | asset_url | stylesheet_tag }}
{{ 'rdc_borne.js' | asset_url | script_tag }}