{% schema %}
{
  "name": "Borne RDC",
  "settings": [
    {
      "type": "text",
      "id": "categories",
      "label": "Catégories (séparées par des virgules)",
      "default": "T-shirts, Débardeurs, Sweatshirts",
      "info": "Les images associées doivent être nommées 'nom_categorie.webp'"
    },
    {
      "type": "collection_list",
      "id": "collections",
      "label": "Collections à afficher",
      "limit": 20
    },
    {
      "type": "textarea",
      "id": "collection_descriptions",
      "label": "Descriptions personnalisées des collections",
      "info": "Format : Collection:Description|etc... "
    },
    {
      "type": "textarea",
      "id": "collection_links",
      "label": "Mapping",
      "info": "Liens des catégories avec les collections. Format : Catégorie:Collection,Collection|etc...",
    },
  ],
  "presets": [
    {
      "name": "Borne RDC",
      "category": "Collection"
    }
  ]
}
{% endschema %}

<div class="rdc-borne">
  <button class="rdc-borne__back-button" data-action="back">
    <span class="rdc-borne__back-icon">&larr;</span> Retour
  </button>

  <!-- Écran 1: Catégories -->
  <div class="rdc-borne__screen" data-screen="1" data-active="true">
    <div class="rdc-borne__content">
      <h1 class="rdc-borne__title">Choisissez votre catégorie</h1>
      <div class="rdc-borne__categories">
        {% assign categories = section.settings.categories | split: ',' %}
        {% for category in categories %}
          {% assign category_clean = category | strip %}
          <div class="rdc-borne__category" data-category="{{ category_clean | handleize }}">
            <div class="rdc-borne__category-inner">
              <img src="{{ category_clean | handleize | append: '.webp' | file_url }}" alt="{{ category_clean }}" class="rdc-borne__category-image">
              <h2 class="rdc-borne__category-title">{{ category_clean }}</h2>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Écran 2 -->
  <div class="rdc-borne__screen" data-screen="2" data-active="false">
    <div class="rdc-borne__content">
      <h1>Collections</h1>
      <div class="rdc-borne__collections">
        {% assign category = '' %}
        {% if request.path contains '?' %}
          {% assign params = request.path | split: '?' | last | split: '&' %}
          {% for param in params %}
            {% if param contains 'category=' %}
              {% assign category = param | split: '=' | last %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign selected_collections = section.settings.collection_links | split: '|' %}
        {% for collection in section.settings.collections %}
          {% assign show_collection = false %}
          {% for mapping in selected_collections %}
            {% if mapping contains category and mapping contains collection.title %}
              {% assign show_collection = true %}
              {% break %}
            {% endif %}
          {% endfor %}
          {% if show_collection %}
            <div class="rdc-borne__collection">
              <img src="{{ collection.image | img_url: '600x600', crop: 'center' }}" alt="{{ collection.title }}" class="rdc-borne__collection-image">
              <h3>{{ collection.title }}</h3>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
    <button class="rdc-borne__next-button" data-action="next" data-target="3">Suivant</button>
  </div>

  <!-- Écran 3: Produits de la collection -->
  <div class="rdc-borne__screen" data-screen="3" data-active="false">
    <div class="rdc-borne__content">
      {% if request.path contains 'collection=' %}
        {% assign collection_handle = request.path | split: 'collection=' | last | split: '&' | first %}
        {% assign collection = collections[collection_handle] %}
        <h1>{{ collection.title }}</h1>
        <div class="rdc-borne__products">
          {% for product in collection.products %}
            <div class="rdc-borne__product">
              <img src="{{ product.featured_image | img_url: '600x600', crop: 'center' }}" alt="{{ product.title }}" class="rdc-borne__product-image">
              <h3>{{ product.title }}</h3>
              <p class="rdc-borne__product-price">{{ product.price | money }}</p>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <h1>Aucune collection sélectionnée</h1>
      {% endif %}
    </div>
    <button class="rdc-borne__next-button" data-action="next" data-target="4">Suivant</button>
  </div>

  <!-- Écran 4: Détail produit -->
  <div class="rdc-borne__screen" data-screen="4" data-active="false">
    <div class="rdc-borne__content">
      <div class="rdc-borne__product-detail">
        <div class="rdc-borne__product-images">
          <img class="rdc-borne__product-main-image" src="" alt="">
          <div class="rdc-borne__product-thumbnails"></div>
        </div>
        <div class="rdc-borne__product-info">
          <h1 class="rdc-borne__product-title"></h1>
          <div class="rdc-borne__product-price"></div>
          <div class="rdc-borne__product-description"></div>
          <div class="rdc-borne__product-variants"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="application/json" id="rdc-borne-data">
  {{ section.settings.collection_links }}
</script>

<script type="application/json" id="rdc-borne-collection-images">
  {% assign collection_images = '' %}
  {% for collection in section.settings.collections %}
    {% assign collection_images = collection_images | append: collection.title | append: ':' | append: collection.image | img_url: '600x600', crop: 'center' %}
    {% unless forloop.last %}
      {% assign collection_images = collection_images | append: '|' %}
    {% endunless %}
  {% endfor %}
  {{ collection_images }}
</script>

{{ 'rdc_borne.css' | asset_url | stylesheet_tag }}
{{ 'rdc_borne.js' | asset_url | script_tag }}